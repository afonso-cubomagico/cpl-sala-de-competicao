<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cubic Portugal League</title>
  <style>
    /* Fundo “clean” com gradiente suave */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #e0eafc, #cfdef3);
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    /* Título mais estilizado */
    h1 {
      color: #2c3e50;
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 20px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
      margin-bottom: 20px;
    }
    input, button {
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
      width: 100%;
      border-radius: 10px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background-color: #34495e;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background-color: #2c3e50;
    }
    .scramble {
      font-weight: bold;
      margin: 10px 0;
      font-size: 1.2em;
    }
    /* Penalidades centralizadas verticalmente sob o texto */
    .penalties {
      display: flex;
      justify-content: space-around;
      margin: 10px 0;
    }
    .penalties label {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 16px;
    }
    .penalties input {
      margin-top: 5px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    /* Esconde as seções que não devem aparecer inicialmente */
    #confirmContainer, #solveContainer, #resultsContainer {
      display: none;
    }
    /* Estilos para estatísticas finais */
    .stats {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      font-weight: bold;
      font-size: 1.1em;
    }
  </style>
</head>
<body>
  <h1>Cubic Portugal League</h1>

  <!-- 1) Container para inserir o ID da sala -->
  <div class="container" id="idContainer">
    <input type="text" id="idInput" placeholder="Introduz o ID da sala">
    <button onclick="verificarID()">Entrar</button>
  </div>

  <!-- 2) Aviso de gravação antes de prosseguir -->
  <div class="container" id="confirmContainer">
    <p style="font-size: 1.1em; text-align: center;">
      É obrigatório que já estejas a gravar esta disputa para continuar
    </p>
    <button id="btnConfirmar">Confirmo que estou a gravar</button>
  </div>

  <!-- 3) Container onde aparecem scrambles e campos para introduzir tempos -->
  <div class="container" id="solveContainer">
    <div id="solveFields">
      <div id="scramble" class="scramble"></div>
      <input type="text" id="tempoInput" placeholder="Tempo (ex: 12.34)">
      <div class="penalties">
        <label>
          +2
          <input type="checkbox" name="plus2" value="+2">
        </label>
        <label>
          DNF
          <input type="checkbox" name="dnf" value="DNF">
        </label>
      </div>
      <button onclick="submeterTempo()">Submeter tempo</button>
    </div>

    <!-- Tabela de resultados durante as solves -->
    <table id="tabelaTempos">
      <thead>
        <tr><th>Scramble</th><th>Tempo</th><th>Penalidade</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="mediaFinal" style="margin-top:20px; font-weight:bold;"></div>
  </div>

  <!-- 4) Container com resultados finais: tabela + estatísticas -->
  <div class="container" id="resultsContainer">
    <h2>Resultados Finais</h2>

    <table id="finalTabela">
      <thead>
        <tr><th>Scramble</th><th>Tempo</th><th>Penalidade</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Estatísticas finais: Single à esquerda, Ao5 à direita -->
    <div class="stats">
      <span id="bestSingle"></span>
      <span id="finalAo5"></span>
    </div>
  </div>

  <!-- Script principal: Firebase + lógica da Cubic Portugal League -->
  <script type="module">
    // 1) Importar Firebase core, analytics e Realtime Database
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
    import { getDatabase, ref, runTransaction } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

    // 2) Configuração do Firebase (já tens estas credenciais)
    const firebaseConfig = {
      apiKey: "AIzaSyAFgCXSwRcM9Jmn6cGdG848A5uCbN8coNI",
      authDomain: "cpl-id-sala-80132.firebaseapp.com",
      projectId: "cpl-id-sala-80132",
      storageBucket: "cpl-id-sala-80132.firebasestorage.app",
      messagingSenderId: "342930536800",
      appId: "1:342930536800:web:25ec461bf0e1cd97e48605",
      measurementId: "G-ND6FTLKXRY"
    };

    // 3) Inicializar Firebase e Analytics
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    // 4) Inicializar Realtime Database
    const database = getDatabase(app);

    // 5) Objeto com todos os IDs e scrambles (mantido como tinhas)
    const scramblesPorID = {
      "X7M3A9": [
        "F2 R U2 R' B2 F R2 U2 L D' R U' R' F' L U2 F2 U'",
        "B L2 D2 B' L U' R2 D' R' F2 L' U2 F' L2 U' F' D2",
        "R U R2 F D2 L' B' U' F2 R B' R' F L2 D F R",
        "D2 L2 F U' L D' B2 U2 R' F L' B2 R2 U F' L2 D B",
        "F R2 U' L2 F' U B2 R F L' F2 U B2 L' U F' L D"
      ],
      "L2P8Q5": [
        "D2 L' F2 U R2 F D' B2 U' F' D R2 F' L2 U F2 R'",
        "R F2 D B L2 F R2 U' R F L U F' B2 U2 F R2",
        "U F2 B R2 U L D' F L' U2 F R B2 D' R2 U2 F'",
        "F' L D' R F2 U L' F' L2 U2 F' R2 L' D' B2 L D",
        "L F2 U L D' R B2 U R2 F' U' L D2 R U2 L F"
      ],
      "A1C7X3": [
        "R2 U2 F D' B R' L U R2 F U' L B' R' U2 F' L D'",
        "L' B2 R U2 L D' F2 R' F L2 U' B' D R U' R2 F L'",
        "D F' R' F2 D2 B U R L2 F R2 D' F' R' L2 B' R U",
        "F L' R U2 F L U' F L2 U' B2 D R2 F' D' R2 F L",
        "B2 U R F2 U' F' D B R2 F' L2 U2 F R' B2 D F' L"
      ],
      "T9K2Z8": [
        "F2 U L D B L F' R2 F R U' B2 F2 U' F R2 F' L",
        "B2 L2 U' R' F' D2 R F2 U2 L R' F' D L2 R U' F2",
        "U F' R U' F2 D' F L' F' L F' R2 U' L2 F2 U L",
        "D2 R F U' F R2 L U' F R2 B' D' F2 R U' F' R D",
        "L' F R2 B L D' F' L2 U' F R2 F D L' R F' L B"
      ],
      "B6F4N2": [
        "U2 R2 F U L D' B2 F R' F' U' R2 F2 D F L D2 F",
        "F' R2 D2 L2 U' F L D R' F L2 B' U' F' R D' F2",
        "L2 F' R L2 F' L D2 F R2 U' F D' F' R2 F U F2 D",
        "D R U' F L U' R2 F U2 F' R2 F L D' F' R U F'",
        "F U L' R U' R2 F D' F' R' D' F' U' F R U' L2"
      ],
      "J3W7V1": [
        "R2 D F R L U' L F' R U' F2 B' U2 F R' L F' D",
        "U' F R2 F' R2 U F2 B2 L2 R' F U' F2 D L2 R U",
        "L F D L U2 R' F L U F2 D' R2 U' F2 U F2 D' L2",
        "F2 D F' R L F2 B L U L2 F' D2 B R' F R2 F2 D2",
        "F D R U' L2 F2 U F' R2 B2 D L' F U' R2 F' U'"
      ],
      "R5Y8M4": [
        "F2 U R F2 L2 U2 F' L' R F2 D2 B2 R' F R2 F' L D",
        "L2 U2 R D L2 F R' F2 U R F2 U L2 R' F2 L2 F L",
        "B2 U F R L U2 F2 D' F' L R2 F' U F' R F2 R2 U",
        "R U F2 L' F2 R' L2 F D L2 F2 U' L' D' L R F U2",
        "L F U' F R2 U F' R2 F D' F2 B2 U' L' F' L F' D"
      ],
      "P2X9L7": [
        "D' F2 L F2 R' F U2 L U' F' L2 F' D' B' F L2 F'",
        "U F R2 U' F R' U2 F' D L2 F' U' R F L' U2 R",
        "L' F2 U R F' L D' F' R F2 D R2 U F' L' F2 R L",
        "B2 L2 F U L' F D' R2 F' R U2 F' R2 F2 U' F' L2",
        "U' F2 R L U F' R F' L2 F' R U' F2 L F' D F' U"
      ],
      "K1Z4T8": [
        "F' U R2 F L' R F' D' F L U' F R2 F2 L' F2 L2 F",
        "D' R F' D F2 L2 F' D R U2 F' R L' D2 F' U2 F2",
        "R U' F2 L2 F D2 L' F U2 F R F2 R L' F2 U F L",
        "D R2 F L U R L U' F' R' F' U' F L2 D' F' L2 F'",
        "U' F2 R L D' F R L' F' U2 F' L U' F L F2 R2 F'"
      ],
      "N8B3F6": [
        "L' F R2 F2 R' F' D' R' U L2 U F' L2 R' U F' L2",
        "F2 L F2 U F R2 D2 L' F' U' R' F2 L D2 L F' R2",
        "F D L F2 U2 R L' F U2 F L' F2 R U2 F' L2 D' F2",
        "U2 F R L U' R2 D' R F2 L2 U' F2 D' F' R' L' U2 F",
        "U' L2 D' F' L2 D' L2 F2 U2 F' R F2 L2 U' F R F'"
      ]
    };

    // 6) Variáveis de estado do jogo
    let solves = [];
    let scrambles = [];
    let idAtual = "";
    let solveIndex = 0;

    // 7) Função para verificar se o ID existe e prosseguir para o aviso de gravação
    function verificarID() {
      const id = document.getElementById("idInput").value.trim().toUpperCase();
      if (!scramblesPorID[id]) {
        alert("ID inválido!");
        return;
      }

      idAtual = id;
      scrambles = scramblesPorID[id];
      solves = [];
      solveIndex = 0;

      // Esconde a caixa de inserir ID e mostra o aviso de gravação
      document.getElementById("idContainer").style.display = "none";
      document.getElementById("confirmContainer").style.display = "block";
    }

    // 8) Função para incrementar a contagem desse ID no Realtime Database
    function incrementarContagem(idSala) {
      const countRef = ref(database, 'contagemID/' + idSala);
      runTransaction(countRef, (valorAtual) => {
        return (valorAtual || 0) + 1;
      })
      .then(() => {
        console.log("Contagem aumentada para o ID: " + idSala);
      })
      .catch((erro) => {
        console.error("Erro ao aumentar contagem:", erro);
      });
    }

    // 9) Liga o botão "Confirmo que estou a gravar" à função de contagem + continuação da interface
    document.getElementById('btnConfirmar').addEventListener('click', () => {
      // Incrementa a contagem daquele ID no Firebase
      incrementarContagem(idAtual);

      // Esconde o aviso e mostra o container de solves
      document.getElementById("confirmContainer").style.display = "none";
      document.getElementById("solveContainer").style.display = "block";
      mostrarProximoScramble();
    });

    // 10) Funções originais para gerir os scrambles e tempos

    function mostrarProximoScramble() {
      if (solveIndex >= 5) {
        finalizarSessao();
        return;
      }
      document.getElementById("scramble").innerText =
        `Scramble #${solveIndex + 1}: ${scrambles[solveIndex]}`;
      document.getElementById("tempoInput").value = "";

      // Limpa checkboxes de penalidade
      document.querySelector('input[name="plus2"]').checked = false;
      document.querySelector('input[name="dnf"]').checked = false;
    }

    function submeterTempo() {
      const tempoStr = document.getElementById("tempoInput").value;
      const plus2Checked = document.querySelector('input[name="plus2"]').checked;
      const dnfChecked = document.querySelector('input[name="dnf"]').checked;

      if (!tempoStr || isNaN(parseFloat(tempoStr))) {
        alert("Insere um tempo válido antes de submeter!");
        return;
      }
      const tempo = parseFloat(tempoStr);

      let tempoParaCalculo, displayTempo, penalidade;
      if (dnfChecked) {
        tempoParaCalculo = Infinity;
        displayTempo = "DNF";
        penalidade = "DNF";
      } else if (plus2Checked) {
        tempoParaCalculo = tempo + 2;
        displayTempo = (tempo + 2).toFixed(2);
        penalidade = "+2";
      } else {
        tempoParaCalculo = tempo;
        displayTempo = tempo.toFixed(2);
        penalidade = "";
      }

      solves.push({
        scramble: scrambles[solveIndex],
        tempo: tempoParaCalculo,
        displayTempo: displayTempo,
        penalidade: penalidade
      });

      atualizarTabela();
      solveIndex++;
      mostrarProximoScramble();
    }

    function atualizarTabela() {
      const tbody = document.querySelector("#tabelaTempos tbody");
      tbody.innerHTML = "";
      solves.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${s.scramble}</td><td>${s.displayTempo}</td><td>${s.penalidade}</td>`;
        tbody.appendChild(tr);
      });
    }

    function finalizarSessao() {
      // Esconde todo o container de solves
      document.getElementById("solveContainer").style.display = "none";

      document.getElementById("resultsContainer").style.display = "block";
      const finalTbody = document.querySelector("#finalTabela tbody");
      finalTbody.innerHTML = "";
      solves.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${s.scramble}</td><td>${s.displayTempo}</td><td>${s.penalidade}</td>`;
        finalTbody.appendChild(tr);
      });

      calcularEstatisticas();
    }

    function calcularEstatisticas() {
      // Calcular Single (sem “s”)
      const temposValidosParaSingle = solves
        .map(s => s.tempo)
        .filter(t => t !== Infinity);

      let bestSingleDisplay;
      if (temposValidosParaSingle.length > 0) {
        const best = Math.min(...temposValidosParaSingle);
        bestSingleDisplay = best.toFixed(2);
      } else {
        bestSingleDisplay = "DNF";
      }
      document.getElementById("bestSingle").innerText = `Single: ${bestSingleDisplay}`;

      // Calcular Ao5 (sem “s”)
      const temposParaAo5 = solves.map(s => s.tempo);
      if (temposParaAo5.filter(t => t === Infinity).length > 1) {
        document.getElementById("finalAo5").innerText = "Ao5: DNF";
        return;
      }
      const classificados = [...temposParaAo5].sort((a, b) => a - b);
      if (classificados.length === 5) {
        classificados.shift();
        classificados.pop();
      }
      const soma = classificados.reduce((acc, val) => acc + val, 0);
      const media = soma / classificados.length;
      document.getElementById("finalAo5").innerText = `Ao5: ${media.toFixed(2)}`;
    }
  </script>
</body>
</html>